name: Lighthouse

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lighthouse:
    name: Lighthouse Audit (${{ matrix.theme }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        theme:
          - light-default
          - light-warm
          - dark-default
          - dark-cool
          - high-contrast-light
          - high-contrast-dark
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Create Environment Files
        run: |
          cp src/environments/environment.example.ts src/environments/environment.ts
          cp src/environments/environment.example.ts src/environments/environment.prod.ts

      - name: Install dependencies
        run: npm ci

      - name: Build production
        run: npm run build

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: ./lighthouserc.json
          urls: |
            http://localhost/index.html?theme=${{ matrix.theme }}
          uploadArtifacts: true
          artifactName: lighthouse-results-${{ matrix.theme }}
          temporaryPublicStorage: true

  # Aggregation job to satisfy branch protection rules
  lighthouse-check:
    if: always()
    needs: lighthouse
    runs-on: ubuntu-latest
    name: Lighthouse Audit
    steps:
      - name: Check matrix status
        if: ${{ contains(needs.lighthouse.result, 'failure') || contains(needs.lighthouse.result, 'cancelled') }}
        run: exit 1

      - name: Success
        run: echo "All Lighthouse audits passed"
